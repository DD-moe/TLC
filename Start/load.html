<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Średnia obrazów i zapis do IndexedDB</title>
</head>
<body>

<h2>Wczytaj obrazy i zapisz wynik do IndexedDB</h2>
<input type="file" id="fileInput" multiple accept="image/*">
<canvas id="canvas"></canvas>

<script>
const fileInput = document.getElementById("fileInput");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let sumArray = null;
let imageCount = 0;
let imageWidth = 0, imageHeight = 0;

// ** Inicjalizacja IndexedDB **
const dbRequest = indexedDB.open("ImageDB", 1);
let db;
dbRequest.onupgradeneeded = (event) => {
    db = event.target.result;
    if (!db.objectStoreNames.contains("images")) {
        db.createObjectStore("images");
    }
};
dbRequest.onsuccess = (event) => {
    db = event.target.result;
};
dbRequest.onerror = (event) => {
    console.error("Błąd IndexedDB", event.target.error);
};

// ** Obsługa wczytywania plików **
fileInput.addEventListener("change", async (event) => {
    const files = event.target.files;
    if (files.length === 0) return;
    
    sumArray = null;
    imageCount = 0;

    for (const file of files) {
        const img = await loadImage(file);
        if (!img) continue;

        // ** Sprawdzenie rozmiaru **
        if (imageWidth === 0 && imageHeight === 0) {
            imageWidth = img.width;
            imageHeight = img.height;
            canvas.width = imageWidth;
            canvas.height = imageHeight;
        } else if (img.width !== imageWidth || img.height !== imageHeight) {
            alert("Wszystkie obrazy muszą mieć ten sam rozmiar!");
            return;
        }

        // ** Pobranie ImageData **
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);
        const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;

        // ** Sumowanie wartości **
        if (!sumArray) {
            sumArray = new Uint32Array(imgData.length);  // 32-bit int dla sumy
        }
        for (let i = 0; i < imgData.length; i++) {
            sumArray[i] += imgData[i];
        }
        
        imageCount++;
    }

    if (imageCount > 0) {
        processAverage();
    }
});

// ** Ładowanie obrazu jako obiekt Image **
function loadImage(file) {
    return new Promise((resolve) => {
        const img = new Image();
        img.src = URL.createObjectURL(file);
        img.onload = () => resolve(img);
        img.onerror = () => resolve(null);
    });
}

// ** Obliczanie średniej i zapis do IndexedDB **
function processAverage() {
    if (!sumArray || imageCount === 0) return;

    const avgArray = new Uint8ClampedArray(sumArray.length);
    for (let i = 0; i < sumArray.length; i++) {
        avgArray[i] = Math.round(sumArray[i] / imageCount);
    }

    // ** Wstawienie do canvas **
    const imageData = new ImageData(avgArray, imageWidth, imageHeight);
    ctx.putImageData(imageData, 0, 0);

    // ** Zapis do IndexedDB **
    saveToIndexedDB();
}

// ** Zapis wyniku do IndexedDB jako PNG **
function saveToIndexedDB() {
    canvas.toBlob((blob) => {
        const transaction = db.transaction(["images"], "readwrite");
        const store = transaction.objectStore("images");
        store.put(blob, "averageImage");
        alert("Obraz zapisany w IndexedDB!");
    }, "image/png");
}
</script>

</body>
</html>
