<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obróbka obrazu</title>
</head>
<body>
    <canvas id="canvasBackground"></canvas>
    <canvas id="canvasSpots"></canvas>
    <div id="output"></div>
    <h3 id="konsola">konsola: </h3>
    <input type="number" id="threshold" value="1" step="0.1">

    <script>
        // Funkcja do pobierania obrazu z IndexedDB
        async function getImageUrlFromIndexedDB(dbName, storeName, key) {
            const db = await indexedDB.open(dbName, 1);
            return new Promise((resolve, reject) => {
                const transaction = db.result.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e);
            });
        }

        // Funkcja do renderowania obrazu na canvasie
        function drawImageOnCanvas(canvas, imageUrl) {
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
            };
            img.src = imageUrl;
        }

        async function processImages() {
            const dbName = "TLC";
            const storeName = "data";
            const threshold = parseFloat(document.getElementById('threshold').value);

            // Pobierz obrazy i dane z IndexedDB
            const backgroundUrl = await getImageUrlFromIndexedDB(dbName, storeName, "background");
            const spotsUrl = await getImageUrlFromIndexedDB(dbName, storeName, "spots");
            const draggableCoordinates = await getImageUrlFromIndexedDB(dbName, storeName, "draggable_coordinates");

            // Wczytaj obrazy do canvasów
            const canvasBackground = document.getElementById("canvasBackground");
            const canvasSpots = document.getElementById("canvasSpots");

            drawImageOnCanvas(canvasBackground, backgroundUrl);
            drawImageOnCanvas(canvasSpots, spotsUrl);

            // Pobierz ImageData dla tła i plam
            const ctxBackground = canvasBackground.getContext('2d');
            const ctxSpots = canvasSpots.getContext('2d');
            const backgroundData = ctxBackground.getImageData(0, 0, canvasBackground.width, canvasBackground.height);
            const spotsData = ctxSpots.getImageData(0, 0, canvasSpots.width, canvasSpots.height);

            // Przetwarzanie danych
            draggableCoordinates.forEach((fragment) => {
                const { y, height } = fragment;

                // Pobierz fragmenty z ImageData
                const fragmentBackground = ctxBackground.getImageData(0, y, canvasBackground.width, height);
                const fragmentSpots = ctxSpots.getImageData(0, y, canvasSpots.width, height);

                for (let i = 0; i < fragmentBackground.data.length; i += 4) {
                    const redSpot = fragmentSpots.data[i];
                    const redBackground = fragmentBackground.data[i];

                    // Zapobiegamy dzieleniu przez 0
                    let result = redSpot / (redBackground || 1);
                    if (result > threshold) {
                        result = 255;
                    }

                    // Zaktualizuj dane z ImageData
                    fragmentSpots.data[i] = result; // red
                    fragmentSpots.data[i + 1] = result; // green
                    fragmentSpots.data[i + 2] = result; // blue
                    fragmentSpots.data[i + 3] = 255; // alpha
                }

                // Przypisz zmodyfikowany fragment z powrotem do canvasu
                ctxSpots.putImageData(fragmentSpots, 0, y);
            });

            // Wyświetl wyniki
            document.getElementById('output').innerHTML = 'Przetwarzanie zakończone';
        }

        // Uruchom proces
        processImages();
    </script>
</body>
</html>
