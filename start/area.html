<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obraz z IndexedDB</title>
    <style>
        body { text-align: center; font-family: Arial, sans-serif; margin: 0; padding: 0; }
        #imageContainer { position: relative; width: 98%; overflow: hidden; margin-left: 1%;}
        #uploadedImage { width: 100%; display: none; }
        #overlay { position: absolute; border: 2px solid red; background: rgba(255, 165, 0, 0.8); pointer-events: none; }
        #controlsContainer { height: 200px; overflow-y: scroll; margin-left: 5%; background: #f0f0f0; position: fixed; bottom: 10vh; width: 90%; opacity: 80%;}
        .sliderContainer { margin-bottom: 20px; }
        label { display: block; font-size: 18px; margin-bottom: 5px; }
        input[type="range"] { width: 100%; height: 35px; }
        #saveBtn { margin-top: 10px; font-size: 18px; padding: 10px 20px; cursor: pointer; }
        #output { width: 90%; margin-top: 10px; font-size: 16px; }
    </style>
</head>
<body>
    <h2>Obraz z IndexedDB</h2>
    <nav>
        <ul>
            <li><a href="/TLC/start/normalise.html">normalise</a></li>
            <li><a href="/TLC/start/settings.html">settings</a></li>
            <li><a href="/TLC">main menu</a></li>
        </ul>
    </nav>
    
    <div id="imageContainer">
        <img id="uploadedImage">
        <div id="overlay"></div>
    </div>

    <div id="controlsContainer">
        <div class="sliderContainer">
            <label>Top:</label>
            <input type="range" id="topSlider" min="0" max="100" value="20">
        </div>
        <div class="sliderContainer">
            <label>Height:</label>
            <input type="range" id="heightSlider" min="10" max="100" value="50">
        </div>
        <div class="sliderContainer">
            <label>Left:</label>
            <input type="range" id="leftSlider" min="0" max="100" value="20">
        </div>
        <div class="sliderContainer">
            <label>Width:</label>
            <input type="range" id="widthSlider" min="10" max="100" value="50">
        </div>
    </div>

    <button id="saveBtn">Zapisz</button>

    <div class="instruction">
        <h2>Instrukcja używania selekcji ścieżki</h2>
        <p>
          1. Użyj suwaków, aby zaznaczyć interesujący Cię obszar na obrazie. Możesz wybrać całą ścieżkę TLC lub tylko pojedynczą plamkę.  
        </p>
        <p>
          2. Kliknij przycisk <strong>Zapisz</strong>, aby potwierdzić wybór.  
        </p>
        <p class="note">
          Niezależnie od zaznaczonego fragmentu, w kolejnym kroku będziesz mógł wybrać dowolny tryb przetwarzania.  
          Ten etap służy jedynie do określenia części obrazu, którą chcesz analizować.  
        </p>
      </div>

    <script>
        let db;
        const nameBcg = 'averageImage_bcg';
        const uploadedImage = document.getElementById("uploadedImage");
        const overlay = document.getElementById("overlay");
        const topSlider = document.getElementById("topSlider");
        const heightSlider = document.getElementById("heightSlider");
        const leftSlider = document.getElementById("leftSlider");
        const widthSlider = document.getElementById("widthSlider");
        const saveBtn = document.getElementById("saveBtn");

        let naturalWidth = 1, naturalHeight = 1;

        function openDB() {
            const request = indexedDB.open('ImageDB', 1);

            request.onsuccess = function(event) {
                db = event.target.result;
                loadImageFromDB();
            };

            request.onerror = function() {
                alert("Błąd podczas otwierania bazy danych.");
            };
        }

        function loadImageFromDB() {
            const transaction = db.transaction(["images"], "readonly");
            const store = transaction.objectStore("images");
            const bcgRequest = store.get(nameBcg);

            bcgRequest.onsuccess = function() {
                if (bcgRequest.result) {
                    const blob = bcgRequest.result;
                    const url = URL.createObjectURL(blob);
                    uploadedImage.onload = function () {
                        naturalWidth = uploadedImage.naturalWidth;
                        naturalHeight = uploadedImage.naturalHeight;
                        uploadedImage.style.display = "block";
                        updateOverlay();
                    };
                    uploadedImage.src = url;
                } else {
                    alert("Nie znaleziono obrazu w bazie danych.");
                }
            };

            bcgRequest.onerror = function() {
                alert("Błąd podczas ładowania obrazu.");
            };
        }

        function updateOverlay() {
            const topPx = (topSlider.value / 100) * naturalHeight;
            const heightPx = (heightSlider.value / 100) * naturalHeight;
            const leftPx = (leftSlider.value / 100) * naturalWidth;
            const widthPx = (widthSlider.value / 100) * naturalWidth;

            overlay.style.top = (topPx * (uploadedImage.clientHeight / naturalHeight)) + "px";
            overlay.style.height = (heightPx * (uploadedImage.clientHeight / naturalHeight)) + "px";
            overlay.style.left = (leftPx * (uploadedImage.clientWidth / naturalWidth)) + "px";
            overlay.style.width = (widthPx * (uploadedImage.clientWidth / naturalWidth)) + "px";
        }

        document.querySelectorAll("input[type='range']").forEach(slider => {
            slider.addEventListener("input", updateOverlay);
        });

        saveBtn.addEventListener("click", function() {

            const DB_NAME = "ParametryDB";
            const STORE_NAME = "parametry";
            const KEY_PIXEL = "pixel_coords";
            const KEY_PERCENT = "percental_coords";

            function openDB(callback) {
                const request = indexedDB.open(DB_NAME, 1);
                request.onupgradeneeded = function(event) {
                    let db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME);
                    }
                };
                request.onsuccess = function(event) {
                    callback(event.target.result);
                };
                request.onerror = function() {
                    alert("Błąd otwierania bazy danych.");
                };
            }

            function saveToDB(key, value) {
                openDB(db => {
                    const transaction = db.transaction(STORE_NAME, "readwrite");
                    const store = transaction.objectStore(STORE_NAME);
                    store.put(value, key);
                });
            }

            const topPercent = document.getElementById("topSlider").value;
            const heightPercent = document.getElementById("heightSlider").value;
            const leftPercent = document.getElementById("leftSlider").value;
            const widthPercent = document.getElementById("widthSlider").value;

            const pixelCoords = {
                top: Math.round((topPercent / 100) * naturalHeight),
                height: Math.round((heightPercent / 100) * naturalHeight),
                left: Math.round((leftPercent / 100) * naturalWidth),
                width: Math.round((widthPercent / 100) * naturalWidth)
            };
            
            const percentCoords = {
                top: topPercent,
                height: heightPercent,
                left: leftPercent,
                width: widthPercent
            };
            
            saveToDB(KEY_PIXEL, pixelCoords);
            saveToDB(KEY_PERCENT, percentCoords);
            alert("Dane zapisane w IndexedDB!");
        });

        openDB();
    </script>
</body>
</html>
