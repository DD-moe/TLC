<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Load and Crop Image</title>
</head>
<body>
    <h1>Image Viewer</h1>
    <canvas id="canvas" style="border: solid 1px black;"></canvas>
    <button onclick="findSpots()">Process Image</button>
    <input type="number" min="0" max="255" value="240" id="treshold">
    
    <script>
        const nameBcg = 'normalised_image'; // The name of the image to load from IndexedDB
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        const loadImage = () => {
            const request = indexedDB.open("ImageDB", 1);
            request.onsuccess = function(event) {
                const db = event.target.result;
                const transaction = db.transaction(["images"], "readonly");
                const store = transaction.objectStore("images");
                const bcgRequest = store.get(nameBcg);

                bcgRequest.onsuccess = function() {
                    const imageDataUrl = bcgRequest.result;
                    if (imageDataUrl) {
                        // Check if the result is a Data URL (base64 string)
                        if (typeof imageDataUrl === 'string' && imageDataUrl.startsWith('data:image/png;base64')) {
                            const img = new Image();
                            img.src = imageDataUrl;  // Directly use the base64 string as the image source
                            img.onload = () => {
                                // Set canvas size to match image
                                canvas.width = img.width;
                                canvas.height = img.height;
                                ctx.drawImage(img, 0, 0);
                                loadPixelCoordinates(); // Once image is loaded, load pixel coordinates
                            };
                        } else {
                            console.error("Expected a Data URL (base64 string), but got:", imageDataUrl);
                        }
                    } else {
                        console.error("Image not found.");
                    }
                };
            };
        };

        // Load pixel coordinates from 'ParametryDB' to crop the image
        const loadPixelCoordinates = () => {
            const request = indexedDB.open("ParametryDB", 1);
            request.onsuccess = function(event) {
                const db = event.target.result;
                const transaction = db.transaction("parametry", "readonly");
                const store = transaction.objectStore("parametry");
                const getRequest = store.get("pixel_coords");

                getRequest.onsuccess = function() {
                    const coords = getRequest.result;
                    if (coords) {
                        // Assume coords is an object with 'x', 'y', 'width', 'height' for cropping
                        const { top, height, left, width } = coords;
                        // Crop the image based on the coordinates and display on canvas
                        const croppedImage = ctx.getImageData(left, top, width, height);
                        canvas.width = width;
                        canvas.height = height;
                        ctx.putImageData(croppedImage, 0, 0);
                    } else {
                        console.error("Pixel coordinates not found.");
                    }
                };
            };
        };

        // Function to find spots and process the image based on threshold value
        const findSpots = () => {
            const threshold = document.getElementById('treshold').value; // Get threshold from input
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data; // Image data array (RGBA values)

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];     // Red channel
                const g = data[i + 1]; // Green channel
                const b = data[i + 2]; // Blue channel
                const a = data[i + 3]; // Alpha channel

                // Check if the pixel's brightness exceeds the threshold
                if (r > threshold || g > threshold || b > threshold) {
                    // Set blue channel and alpha to 128 if condition is met
                    data[i + 2] = 255; // Set blue channel to maximum
                    data[i + 3] = 128; // Set alpha channel to 128
                }
            }

            // Put the modified image data back onto the canvas
            ctx.putImageData(imageData, 0, 0);
        };

        // Load the image when the page is ready
        loadImage();
    </script>
</body>
</html>
