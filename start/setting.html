<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Damian Bezara, Karol Wr√≥blewski">
    <meta name="creator" content="Damian Bezara">
    <meta name="keywords" content="TLC, chromatography, analysis, Damian Bezara, Karol Wr√≥blewski, chemical analysis, quantitative analysis, open-source">
    <title>Settings</title>
    <link rel="stylesheet" href="./pushdata.css">
    <link rel="icon" href="/TLC/favicon-32x32.png" sizes="32x32" type="image/png">
    <link rel="icon" href="/TLC/favicon-64x64.png" sizes="64x64" type="image/png">
    <style>
        /* Nowe style dodane dla lepszej estetyki i responsywno≈õci */
        h1 {
            color: #312e81; /* Indigo-800 */
            font-size: 2.5rem; /* 40px */
            font-weight: 800;
        }

        a {
            border-width: 1px;
            border-color: #4f46e5; /* Indigo-600 */
            background-color: #eef2ff; /* Indigo-50 */
            color: #4338ca; /* Indigo-700 */
            font-weight: 600;
            border-radius: 0.5rem;
            padding: 0.75rem;
            transition: all 0.2s ease-in-out;
        }

        a:hover {
            background-color: #e0e7ff; /* Indigo-100 */
        }

        button {
            background-color: #eef2ff; /* Indigo-600 */
            color: #4f46e5;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 700;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.2s ease-in-out;
        }

        button:hover {
            background-color: #4338ca; /* Indigo-700 */
        }
        
        input[type="number"], textarea {
            border: 1px solid #d1d5db; /* Gray-300 */
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
        }
        
        input[type="number"]:focus, textarea:focus {
            outline: none;
            border-color: #4f46e5; /* Indigo-600 */
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }

        /* Ustawienie wyglƒÖdu dla "paramList" */
        #paramList {
            display: grid;
            gap: 0.75rem;
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }
    </style>    
</head>

<body>
    <h1>Settings</h1>
    <br>
    <a href="uploader.html" title="photos averaging panel">1Ô∏è‚É£üñºÔ∏è</a>    
    <a href="unwarp.html" title="TLC photos cropping / unwarping panel">2Ô∏è‚É£üìê</a>
    <a href="normaliser.html" title="light equalisation panel">3Ô∏è‚É£üîß</a>    
    <a href="track.html" title="track analysis panel">4Ô∏è‚É£üìä</a>
    <a href="../index.html" title="home">üè†</a>
    <hr>
    <br>
    <h3>Select the parameters to include in the report</h3>
    <div id="paramList"></div>
    <br>
    <br>
    <button id="refresh-cache">refresh cache</button>
    <button id="clearSelection">Deselect all parameters</button>
    <hr>
    <label for="decimalsInput" title="how many decimal places to include in the report for each parameter">Number of decimal places:</label><input type="number" id="decimalsInput">
    <hr>
    <!-- Pr√≥g do wykrycia substancji -->
    <label for="tresholdInput" title="How far is it from the nearest model substance to consider it to be this substance? (basing on retardation factor)">
    Substance recognition threshold (0‚Äì1): 
    </label>
    <input type="number" id="tresholdInput" min="0" max="1" step="0.01" value="0.05">
    <br><br>

    <!-- Lista substancji -->
    <label for="substancesInput">List of substances (JSON):</label><br>
    <textarea id="substancesInput" rows="6" cols="60" placeholder='[
    { "x": 0.12, "name": "Substance A" },
    { "x": 0.35, "name": "Substance B" },
    { "x": 0.78, "name": "Substance C" }
    ]'></textarea>

    <script>
        // List of URLs to be cached
        const resourceLinks = [
            '/TLC/start/internalize.js',
            '/TLC/start/datapush.js',
            '/TLC/start/pushdata.css',
            '/TLC/wiki/wiki.css',
            '/TLC/styles.css',            
            // Add more URLs here
        ];

        // Function to cache all resources
        function cacheResources() {
            let promises = resourceLinks.map(url => {
                return fetch(url, { cache: 'force-cache' })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Fail to load resource: ${url}`);
                        }
                        console.log(`Resource loaded: ${url}`);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            });

            // Wait for all resources to be cached
            Promise.all(promises)
                .then(() => {
                    alert('All "v3" resources cached.');
                });
        }

        // Attach the caching function to the button
        document.getElementById('refresh-cache').addEventListener('click', cacheResources);

    //########## - parametry

        // tablica z parametrami
        const paramDescriptions = [
        "name of substance",
        "name of track",
        "Start to midpoint distance at 5% of height",
        "Start to midpoint distance at 10% of height",
        "Asymmetry factor",
        "Midpoint to end distance at 5% of height",
        "Midpoint to end distance at 10% of height",
        "Substance concentration",
        "Height equivalent to a theoretical plate (HETP) - European Pharmacopeia",
        "Height equivalent to a theoretical plate (HETP) - United States Pharmacopeia",
        "Retention factor (k)",
        "Maximal height on track",
        "Greatest peak surface for track",
        "Index of midpoint",
        "Number of theoretical plates per meter (N/m) - European Pharmacopeia",
        "Number of theoretical plates per meter  (N/m) - United States Pharmacopeia",
        "Number of theoretical plates (N) - European Pharmacopeia",
        "Number of theoretical plates (N) - United States Pharmacopeia",
        "Maximal height of peak",
        "Maximal height of peak / Maximal height on track * 100%",
        "% of greatest peak surface",
        "Plate width in cm",
        "Retention factor (RF)",
        "logarithmic retention factor (RM)",
        "Surface of spot",
        "Tailing factor",
        "Track width in cm",
        "Width of peak at 5% of height",
        "Width of peak at 10% of height",
        "Width of peak at 50% of height",
        "Width of peak at 0% of height",
        "X position 0-1 range of spot centrum",
        "Y position 0-1 range of spot centrum",
        "Separation factor (Œ±)",
        "efficacy - European Pharmacopeia",
        "efficacy- United States Pharmacopeia",
        "Normalized surface",
        "retention",
        "Average Retention Factor",
        "Resolution (RS) - European Pharmacopeia",
        "Resolution (RS) - United States Pharmacopeia",
        "Resolution (RS)",
        "selectivity",
        ];


        const paramListDiv = document.getElementById('paramList');

        // wczytaj wcze≈õniej zapisane zaznaczenia jako obiekt
        let wybrane = {};
        try {
        wybrane = JSON.parse(localStorage.getItem('wybraneParametryTLCv3')) || {};
        if (typeof wybrane !== "object" || wybrane === null || Array.isArray(wybrane)) {
            wybrane = {};
        }
        } catch (e) { wybrane = {}; }

        // generowanie listy checkbox√≥w
        paramDescriptions.forEach(desc => {
        const id = 'param_' + desc.replace(/\s+/g, '_'); // unikalne ID
        const wrapper = document.createElement('div');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = id;
        checkbox.value = desc;
        checkbox.checked = !!wybrane[desc]; // true je≈õli wcze≈õniej zaznaczone

        const label = document.createElement('label');
        label.htmlFor = id;
        label.textContent = desc;

        wrapper.appendChild(checkbox);
        wrapper.appendChild(label);
        paramListDiv.appendChild(wrapper);

        // event po zmianie checkboxa
        checkbox.addEventListener('change', () => {
            // odczyt wszystkich checkbox√≥w
            wybrane = {};
            Array.from(paramListDiv.querySelectorAll('input[type=checkbox]:checked'))
            .forEach(cb => wybrane[cb.value] = true);

            // zapis do localStorage jako JSON obiekt
            localStorage.setItem('wybraneParametryTLCv3', JSON.stringify(wybrane));
        });
        });       
        
        // odznacza parametry
        const clearBtn = document.getElementById('clearSelection');

        clearBtn.addEventListener('click', () => {
            // wyczy≈õƒá zmiennƒÖ i localStorage
            wybrane = {};
            localStorage.setItem('wybraneParametryTLCv3', JSON.stringify(wybrane));

            // od≈õwie≈º stronƒô
            window.location.reload();
        });        


    // liczba miejsc po przecinku
    const decimalsInput = document.getElementById("decimalsInput");

    let decimals = -1;
    try {
        const stored = JSON.parse(localStorage.getItem('decimalsTLCv3'));
        if (typeof stored === 'number') {
            decimals = stored;
        } else {
            decimals = -1; // je≈õli w localStorage co≈õ jest, ale nie liczba
        }
    } catch (e) {
        decimals = -1; // je≈õli JSON niepoprawny
    }

    // ustaw warto≈õƒá inputa
    decimalsInput.value = decimals;

    // event przy zmianie inputa
    decimalsInput.addEventListener("change", () => {
        // odczytaj nowƒÖ warto≈õƒá z inputa i zapisz
        const value = Number(decimalsInput.value);
        if (Number.isNaN(value)) {
            decimals = -1; // je≈õli co≈õ nie jest liczbƒÖ
        } else {
            decimals = value;
        }
        localStorage.setItem('decimalsTLCv3', JSON.stringify(decimals));
    });


    // lista potencjalnych substancji do automatycznego wykrycia
    const substancesInput = document.getElementById("substancesInput");

    let substances = [];
    try {
        const stored = JSON.parse(localStorage.getItem('substancesTLCv3'));
        if (Array.isArray(stored)) {
            substances = stored;
        } else {
            substances = []; // je≈õli w localStorage co≈õ jest, ale nie tablica
        }
    } catch (e) {
        substances = []; // je≈õli JSON niepoprawny
    }

    // ustaw warto≈õƒá inputa jako JSON string
    substancesInput.value = JSON.stringify(substances, null, 2);

    // event przy zmianie inputa
    substancesInput.addEventListener("change", () => {
        try {
            // parsuj nowƒÖ warto≈õƒá z inputa
            const value = JSON.parse(substancesInput.value);

            // je≈õli to tablica ‚Äî zapisz, je≈õli nie, wyczy≈õƒá
            if (Array.isArray(value)) {
                substances = value;
            } else {
                substances = [];
            }
        } catch (e) {
            substances = []; // je≈õli wpisano co≈õ niepoprawnego
        }

        // zapisz do localStorage
        localStorage.setItem('substancesTLCv3', JSON.stringify(substances, null, 2));

        // opcjonalnie, od≈õwie≈º input na poprawny JSON
        substancesInput.value = JSON.stringify(substances, null, 2);
    });


    // pr√≥g do wykrycia substancji
    const tresholdInput = document.getElementById("tresholdInput");

    let treshold = 0.05; // warto≈õƒá domy≈õlna
    try {
        const stored = JSON.parse(localStorage.getItem('tresholdTLCv3'));
        if (Number.isFinite(stored) && stored >= 0 && stored <= 1) {
            treshold = stored; // OK, mamy liczbƒô w zakresie
        } else {
            treshold = 0.05; // niepoprawne dane
        }
    } catch (e) {
        treshold = 0.05; // je≈õli JSON niepoprawny
    }

    // ustaw warto≈õƒá inputa
    tresholdInput.value = treshold;

    // event przy zmianie inputa
    tresholdInput.addEventListener("change", () => {
        // parse float z inputa
        const value = parseFloat(tresholdInput.value);
        if (Number.isNaN(value) || value < 0 || value > 1) {
            treshold = 0.05; // je≈õli co≈õ nie jest liczbƒÖ lub poza zakresem
        } else {
            treshold = value;
        }
        localStorage.setItem('tresholdTLCv3', JSON.stringify(treshold));
        tresholdInput.value = treshold; // zaktualizuj input po ewentualnej korekcie
    });
    </script>
</body>
</html>
