<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ustawienia</title>
    <link rel="stylesheet" href="pushdata.css">
    <link rel="icon" href="/TLC/favicon-32x32.png" sizes="32x32" type="image/png">
    <link rel="icon" href="/TLC/favicon-64x64.png" sizes="64x64" type="image/png">
</head>

<body>
    <h1>Ustawienia</h1>

    <!-- Button to refresh all resources in the cache -->
    <button id="refresh-cache">Odśwież Cache Wszystkich Zasobów</button>
    <br>
    <a href="uploader.html" title="panel ładowania zdjęć">1️⃣🖼️</a>    
    <a href="unwarp.html" title="panel przycinania zdjęcia płytki">2️⃣📐</a>
    <a href="normaliser.html" title="panel ujednolicania oświetlenia">3️⃣🔧</a>    
    <a href="track.html" title="panel analizy ścieżek">4️⃣📊</a>
    <a href="../index.html" title="strona startowa">🏠</a>
    <hr>
    <h3>Wybierz parametry włączane do raportu</h3>
    <div id="paramList"></div>
    <button id="clearSelection">Odznacz parametry</button>
    <hr>
    <label for="decimalsInput" title="ile miejsc po przecinku uwzględniać w raporcie dla każdego parametru">Liczba miejsc po przecinku: </label><input type="number" id="decimalsInput">
    <script>
        // List of URLs to be cached
        const resourceLinks = [
            '/TLC/start/internalize.js',
            '/TLC/start/datapush.js',
            '/TLC/start/pushdata.css',
            '/TLC/wiki/wiki.css',
            '/TLC/styles.css',            
            // Add more URLs here
        ];

        // Function to cache all resources
        function cacheResources() {
            let promises = resourceLinks.map(url => {
                return fetch(url, { cache: 'force-cache' })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Nie udało się załadować zasobu: ${url}`);
                        }
                        console.log(`Zasób załadowany: ${url}`);
                    })
                    .catch(error => {
                        console.error('Błąd:', error);
                    });
            });

            // Wait for all resources to be cached
            Promise.all(promises)
                .then(() => {
                    alert('Wszystkie zasoby zostały zcache’owane.');
                });
        }

        // Attach the caching function to the button
        document.getElementById('refresh-cache').addEventListener('click', cacheResources);

    //########## - parametry

        // tablica z parametrami
        const paramDescriptions = [
        "name of substance",
        "name of track",
        "Start to midpoint distance at 5% of height",
        "Start to midpoint distance at 10% of height",
        "Asymmetry factor",
        "Midpoint to end distance at 5% of height",
        "Midpoint to end distance at 10% of height",
        "Substance concentration",
        "Height equivalent to a theoretical plate (HETP) - European Pharmacopeia",
        "Height equivalent to a theoretical plate (HETP) - United States Pharmacopeia",
        "Retention factor (k)",
        "Maximal height on track",
        "Greatest peak surface for track",
        "Index of midpoint",
        "Number of theoretical plates per meter (N/m) - European Pharmacopeia",
        "Number of theoretical plates per meter  (N/m) - United States Pharmacopeia",
        "Number of theoretical plates (N) - European Pharmacopeia",
        "Number of theoretical plates (N) - United States Pharmacopeia",
        "Maximal height of peak",
        "Maximal height of peak / Maximal height on track * 100%",
        "% of greatest peak surface",
        "Plate width in cm",
        "Retention factor (RF)",
        "logarithmic retention factor (RM)",
        "Surface of spot",
        "Tailing factor",
        "Track width in cm",
        "Width of peak at 5% of height",
        "Width of peak at 10% of height",
        "Width of peak at 50% of height",
        "Width of peak at 0% of height",
        "X position 0-1 range of spot centrum",
        "Y position 0-1 range of spot centrum"
        ];


        const paramListDiv = document.getElementById('paramList');

        // wczytaj wcześniej zapisane zaznaczenia jako obiekt
        let wybrane = {};
        try {
        wybrane = JSON.parse(localStorage.getItem('wybraneParametryTLCv3')) || {};
        if (typeof wybrane !== "object" || wybrane === null || Array.isArray(wybrane)) {
            wybrane = {};
        }
        } catch (e) { wybrane = {}; }

        // generowanie listy checkboxów
        paramDescriptions.forEach(desc => {
        const id = 'param_' + desc.replace(/\s+/g, '_'); // unikalne ID
        const wrapper = document.createElement('div');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = id;
        checkbox.value = desc;
        checkbox.checked = !!wybrane[desc]; // true jeśli wcześniej zaznaczone

        const label = document.createElement('label');
        label.htmlFor = id;
        label.textContent = desc;

        wrapper.appendChild(checkbox);
        wrapper.appendChild(label);
        paramListDiv.appendChild(wrapper);

        // event po zmianie checkboxa
        checkbox.addEventListener('change', () => {
            // odczyt wszystkich checkboxów
            wybrane = {};
            Array.from(paramListDiv.querySelectorAll('input[type=checkbox]:checked'))
            .forEach(cb => wybrane[cb.value] = true);

            // zapis do localStorage jako JSON obiekt
            localStorage.setItem('wybraneParametryTLCv3', JSON.stringify(wybrane));
        });
        });       
        
        // odznacza parametry
        const clearBtn = document.getElementById('clearSelection');

        clearBtn.addEventListener('click', () => {
            // wyczyść zmienną i localStorage
            wybrane = {};
            localStorage.setItem('wybraneParametryTLCv3', JSON.stringify(wybrane));

            // odśwież stronę
            window.location.reload();
        });        

    // liczba miejsc po przecinku
    const decimalsInput = document.getElementById("decimalsInput");

    let decimals = -1;
    try {
        const stored = JSON.parse(localStorage.getItem('decimalsTLCv3'));
        if (typeof stored === 'number') {
            decimals = stored;
        } else {
            decimals = -1; // jeśli w localStorage coś jest, ale nie liczba
        }
    } catch (e) {
        decimals = -1; // jeśli JSON niepoprawny
    }

    // ustaw wartość inputa
    decimalsInput.value = decimals;

    // event przy zmianie inputa
    decimalsInput.addEventListener("change", () => {
        // odczytaj nową wartość z inputa i zapisz
        const value = Number(decimalsInput.value);
        if (Number.isNaN(value)) {
            decimals = -1; // jeśli coś nie jest liczbą
        } else {
            decimals = value;
        }
        localStorage.setItem('decimalsTLCv3', JSON.stringify(decimals));
    });


    // lista potencjalnych substancji do automatycznego wykrycia
    const substancesInput = document.getElementById("substancesInput");

    let substances = [];
    try {
        const stored = JSON.parse(localStorage.getItem('substancesTLCv3'));
        if (Array.isArray(stored)) {
            substances = stored;
        } else {
            substances = []; // jeśli w localStorage coś jest, ale nie tablica
        }
    } catch (e) {
        substances = []; // jeśli JSON niepoprawny
    }

    // ustaw wartość inputa jako JSON string
    substancesInput.value = JSON.stringify(substances);

    // event przy zmianie inputa
    substancesInput.addEventListener("change", () => {
        try {
            // parsuj nową wartość z inputa
            const value = JSON.parse(substancesInput.value);

            // jeśli to tablica — zapisz, jeśli nie, wyczyść
            if (Array.isArray(value)) {
                substances = value;
            } else {
                substances = [];
            }
        } catch (e) {
            substances = []; // jeśli wpisano coś niepoprawnego
        }

        // zapisz do localStorage
        localStorage.setItem('substancesTLCv3', JSON.stringify(substances));

        // opcjonalnie, odśwież input na poprawny JSON
        substancesInput.value = JSON.stringify(substances);
    });
    </script>
</body>
</html>
