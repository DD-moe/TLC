<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Damian Bezara, Karol Wr√≥blewski">
    <meta name="creator" content="Damian Bezara">
    <meta name="keywords" content="TLC, chromatography, analysis, Damian Bezara, Karol Wr√≥blewski, chemical analysis, quantitative analysis, open-source">
    <title>Settings</title>
    <link rel="stylesheet" href="./pushdata.css">
    <link rel="icon" href="/TLC/favicon-32x32.png" sizes="32x32" type="image/png">
    <link rel="icon" href="/TLC/favicon-64x64.png" sizes="64x64" type="image/png">
    <style>
        /* Nowe style dodane dla lepszej estetyki i responsywno≈õci */
        h1 {
            color: #312e81; /* Indigo-800 */
            font-size: 2.5rem; /* 40px */
            font-weight: 800;
        }

        a {
            border-width: 1px;
            border-color: #4f46e5; /* Indigo-600 */
            background-color: #eef2ff; /* Indigo-50 */
            color: #4338ca; /* Indigo-700 */
            font-weight: 600;
            border-radius: 0.5rem;
            padding: 0.75rem;
        }

        a:hover {
            background-color: #e0e7ff; /* Indigo-100 */
        }

        button {
            background-color: #eef2ff; /* Indigo-600 */
            color: #4f46e5;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 700;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            background-color: #4338ca; /* Indigo-700 */
        }
        
        input[type="number"], textarea {
            border: 1px solid #d1d5db; /* Gray-300 */
            padding: 0.5rem;
            border-radius: 0.5rem;
        }
        
        input[type="number"]:focus, textarea:focus {
            outline: none;
            border-color: #4f46e5; /* Indigo-600 */
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }

        /* Ustawienie wyglƒÖdu dla "paramList" */
        #Chrom_paramListDiv, #Int_paramListDiv, #Qname_paramListDiv, #Pha_paramListDiv {
            display: grid;
            gap: 0.75rem;
            grid-template-columns: repeat(1, minmax(0, 1fr));
            border: solid 2px black;
        }

        #Int_paramListDiv{
            background-color: bisque;
        }
        #Chrom_paramListDiv{
            background-color: thistle;
        }
        #Qname_paramListDiv{
            background-color: white;
        }
        #Pha_paramListDiv{
            background-color: lavender;
        }                
        
    </style>    
</head>

<body>
    <h1>Settings</h1>
    <br>
    <a href="uploader.html" title="photos averaging panel">1Ô∏è‚É£üñºÔ∏è</a>    
    <a href="unwarp.html" title="TLC photos cropping / unwarping panel">2Ô∏è‚É£üìê</a>
    <a href="normaliser.html" title="light equalisation panel">3Ô∏è‚É£üîß</a>    
    <a href="track.html" title="track analysis panel">4Ô∏è‚É£üìä</a>
    <a href="../index.html" title="home">üè†</a>
    <br>
    <hr>
    <br>
    <h3>Select the parameters to include in the report</h3>
        <br>
        <div id="Qname_paramListDiv"><p>Quantity and naming parameters:</p><br></div>            
        <br>
        <div id="Chrom_paramListDiv"><p>Chromatographic parameters:</p><br></div>
        <br>
        <div id="Pha_paramListDiv"><p>Chromatographic (Pharmaopeia dependent) parameters:</p><br></div>        
        <br>
        <div id="Int_paramListDiv"><p>Intermediate parameters:</p><br></div>
    <br>
        <h3>Select Naming Convention:</h3><br>
    
    <select id="namingConventionSelect" onchange="saveNamingConvention()">
        <option value="debug" selected>Debug Naming</option>
        
        <option value="descriptive">Descriptive</option>
        
        <option value="abbreviated">Abbreviated</option>
        
        <option value="desc_abbrev">Desc. & Abbrev.</option>
    </select>
    <br>
    <hr>
    <br>
    <button id="refresh-cache">refresh cache</button>
    <button id="clearSelection">Deselect all parameters</button>
    <br>
    <hr>
    <br>
    <label for="decimalsInput" title="how many decimal places to include in the report for each parameter">Number of decimal places:</label><input type="number" id="decimalsInput">
    <br>
    <hr>
    <br>
    <!-- Pr√≥g do wykrycia substancji -->
    <label for="tresholdInput" title="How far is it from the nearest model substance to consider it to be this substance? (basing on retardation factor)">
    Substance recognition threshold (0‚Äì1): 
    </label>
    <input type="number" id="tresholdInput" min="0" max="1" step="0.01" value="0.05">
    <br><br>

    <!-- Lista substancji -->
    <label for="substancesInput">List of substances (JSON):</label><br>
    <textarea id="substancesInput" rows="6" cols="60" placeholder='[
    { "x": 0.12, "name": "Substance A" },
    { "x": 0.35, "name": "Substance B" },
    { "x": 0.78, "name": "Substance C" }
    ]'></textarea>

    <script>
        // List of URLs to be cached
        const resourceLinks = [
            '/TLC/start/internalize.js',
            '/TLC/start/datapush.js',
            '/TLC/start/pushdata.css',
            '/TLC/wiki/wiki.css',
            '/TLC/styles.css',            
            // Add more URLs here
        ];

        // Function to cache all resources
        function cacheResources() {
            let promises = resourceLinks.map(url => {
                return fetch(url, { cache: 'force-cache' })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Fail to load resource: ${url}`);
                        }
                        console.log(`Resource loaded: ${url}`);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            });

            // Wait for all resources to be cached
            Promise.all(promises)
                .then(() => {
                    alert('All "v3" resources cached.');
                });
        }

        // Attach the caching function to the button
        document.getElementById('refresh-cache').addEventListener('click', cacheResources);

    //########## - parametry

        // tablica z parametrami
        const paramDescriptions = [
        {name: "Peak Name (PN)", type:"qname"},
        {name: "Track Name (TN)", type:"qname"},
        {name: "Startpoint to Midpoint Distance at 5% of Height (SM5)", type:"int"},
        {name: "Startpoint to Midpoint Distance at 10% of Height (SM10)", type:"int"},
        {name: "Asymmetry Factor‚Äã‚Äã (AS)", type:"chrom"},
        {name: "Midpoint to Endpoint Distance at 5% of Height (ME5)", type:"int"},
        {name: "Midpoint to Endpoint Distance at 10% of Height (ME10)", type:"int"},
        {name: "Substance Concentration (C)", type:"qname"},
        {name: "Height Equivalent to a Theoretical Plate - European Pharmacopeia (HETPEP)", type:"pha"},
        {name: "Height Equivalent to a Theoretical Plate - United States Pharmacopeia (HETPUSP)", type:"pha"},
        {name: "Capacity Factor (k)", type:"chrom"},
        {name: "Maximal Height on Track (HTrack)", type:"int"},
        {name: "Greatest Peak Surface for Track (STrack)", type:"int"},
        {name: "Midpoint Index (MI)‚Äã", type:"int"},
        {name: "Number of Theoretical Plates per meter - European Pharmacopeia‚Äã (NEP/m)", type:"pha"},
        {name: "Number of Theoretical Plates per meter - United States Pharmacopeia (NUSP/m)", type:"pha"},
        {name: "Number of Theoretical Plates - European Pharmacopeia‚Äã (NEP)", type:"pha"},
        {name: "Number of Theoretical Plates - United States Pharmacopeia‚Äã (NUSP)", type:"pha"},
        {name: "Peak Height (H)", type:"chrom"},
        {name: "Peak Height to Track Height Ratio (H%)", type:"chrom"},
        {name: "Peak Surface to Track Surface Ratio (S%)", type:"qname"},
        {name: "Plate Width in cm (PlW)", type:"int"},
        {name: "Retardation Factor (RF)", type:"chrom"},
        {name: "Logarithmic Retardation Factor (RMLog10)", type:"chrom"},
        {name: "Spot Area¬†(S)", type:"qname"},
        {name: "Tailing Factor (TF)", type:"chrom"},
        {name: "Track Length in cm (Tl)", type:"int"},
        {name: "Peak Width at 5% Height (PW5)", type:"int"},
        {name: "Peak Width at 10% Height (PW10)", type:"int"},
        {name: "Peak Width at 50% Height (PW50)", type:"int"},
        {name: "Peak Width at 0% Height (PW0)", type:"int"},
        {name: "X Position of Spot Center (XPOS)", type:"int"},
        {name: "Y Position of Spot Center (YPOS)", type:"int"},
        {name: "Separation Factor (Œ±)", type:"chrom"},
        {name: "Efficiency - European Pharmacopeia (EEP)", type:"int"},
        {name: "Efficiency - United States Pharmacopeia (EUSP)", type:"int"},
        {name: "Normalized Surface (NS)", type:"qname"},
        {name: "Retention (Ret)", type:"int"},
        {name: "Average Retention Factor (RÀâF)", type:"int"},
        {name: "Resolution - European Pharmacopeia (REP)", type:"pha"},
        {name: "Resolution - United States Pharmacopeia (RUSP)", type:"pha"},
        {name: "Resolution - Universal Formula (RS)", type:"chrom"},
        {name: "Selectivity (Sel)", type:"int"},
        ];

        const namingConvention = {
            "PN": {
                abbv: "P<sub>N</sub>",
                desc: "Peak Name"
            },
            "TN": {
                abbv: "T<sub>N</sub>",
                desc: "Track Name"
            },
            "SM5": {
                abbv: "SM<sub>5</sub>",
                desc: "Startpoint to Midpoint Distance at 5% of Height"
            },
            "SM10": {
                abbv: "SM<sub>10</sub>",
                desc: "Startpoint to Midpoint Distance at 10% of Height"
            },
            "AS": {
                abbv: "A<sub>S</sub>",
                desc: "Asymmetry Factor"
            },
            "ME5": {
                abbv: "ME<sub>5</sub>",
                desc: "Midpoint to Endpoint Distance at 5% of Height"
            },
            "ME10": {
                abbv: "ME<sub>10</sub>",
                desc: "Midpoint to Endpoint Distance at 10% of Height"
            },
            "C": {
                abbv: "C",
                desc: "Substance Concentration"
            },
            "HETPEP": {
                abbv: "HETP<sub>EP</sub>",
                desc: "Height Equivalent to a Theoretical Plate - European Pharmacopeia"
            },
            "HETPUSP": {
                abbv: "HETP<sub>USP</sub>",
                desc: "Height Equivalent to a Theoretical Plate - United States Pharmacopeia"
            },
            "k": {
                abbv: "k",
                desc: "Capacity Factor"
            },
            "HTrack": {
                abbv: "H<sub>Track</sub>",
                desc: "Maximal Height on Track"
            },
            "STrack": {
                abbv: "S<sub>Track</sub>",
                desc: "Greatest Peak Surface for Track"
            },
            "MI": {
                abbv: "M<sub>I</sub>",
                desc: "Midpoint Index"
            },
            "NEP/m": {
                abbv: "N<sub>EP</sub>/m",
                desc: "Number of Theoretical Plates per meter - European Pharmacopeia"
            },
            "NUSP/m": {
                abbv: "N<sub>USP</sub>/m",
                desc: "Number of Theoretical Plates per meter - United States Pharmacopeia"
            },
            "NEP": {
                abbv: "N<sub>EP</sub>",
                desc: "Number of Theoretical Plates - European Pharmacopeia"
            },
            "NUSP": {
                abbv: "N<sub>USP</sub>",
                desc: "Number of Theoretical Plates - United States Pharmacopeia"
            },
            "HMax": {
                abbv: "H<sub>Max</sub>",
                desc: "Peak Height"
            },
            "H%": {
                abbv: "H<sub>%</sub>",
                desc: "Peak Height to Track Height Ratio"
            },
            "S%": {
                abbv: "S<sub>%</sub>",
                desc: "Peak Surface to Track Surface Ratio"
            },
            "PlW": {
                abbv: "Pl<sub>W</sub>",
                desc: "Plate Width in cm"
            },
            "RF": {
                abbv: "R<sub>F</sub>",
                desc: "Retardation Factor"
            },
            "RMLog10": {
                abbv: "R<sub>M</sub>",
                desc: "Logarithmic Retardation Factor"
            },
            "S": {
                abbv: "S",
                desc: "Spot Area"
            },
            "TF": {
                abbv: "T<sub>F</sub>",
                desc: "Tailing Factor"
            },
            "Tl": {
                abbv: "T<sub>L</sub>",
                desc: "Track Length in cm"
            },
            "PW5": {
                abbv: "PW<sub>5</sub>",
                desc: "Peak Width at 5% Height"
            },
            "PW10": {
                abbv: "PW<sub>10</sub>",
                desc: "Peak Width at 10% Height"
            },
            "PW50": {
                abbv: "PW<sub>50</sub>",
                desc: "Peak Width at 50% Height"
            },
            "PW0": {
                abbv: "PW<sub>0</sub>",
                desc: "Peak Width at 0% Height"
            },
            "XPOS": {
                abbv: "X<sub>POS</sub>",
                desc: "X Position of Spot Center"
            },
            "YPOS": {
                abbv: "Y<sub>POS</sub>",
                desc: "Y Position of Spot Center"
            },
            "Œ±": {
                abbv: "Œ±",
                desc: "Separation Factor"
            },
            "EEP": {
                abbv: "E<sub>EP</sub>",
                desc: "Efficiency - European Pharmacopeia"
            },
            "EUSP": {
                abbv: "E<sub>USP</sub>",
                desc: "Efficiency - United States Pharmacopeia"
            },
            "NS": {
                abbv: "N<sub>S</sub>",
                desc: "Normalized Surface"
            },
            "Ret": {
                abbv: "Ret",
                desc: "Retention"
            },
            "RÀâF": {
                abbv: "R&#772;<sub>F</sub>",
                desc: "Average Retention Factor"
            },
            "REP": {
                abbv: "R<sub>EP</sub>",
                desc: "Resolution - European Pharmacopeia"
            },
            "RUSP": {
                abbv: "R<sub>USP</sub>",
                desc: "Resolution - United States Pharmacopeia"
            },
            "RS": {
                abbv: "R<sub>S</sub>",
                desc: "Resolution - Universal Formula"
            },
            "Sel": {
                abbv: "Sel",
                desc: "Selectivity"
            }
        };

        // Funkcja JavaScript do zapisywania warto≈õci do Local Storage
        function saveNamingConvention() {
            // Pobranie elementu select po jego ID
            const selectElement = document.getElementById('namingConventionSelect');
            
            // Pobranie wybranej warto≈õci
            const selectedValue = selectElement.value;
            
            // Klucz, pod kt√≥rym warto≈õƒá bƒôdzie zapisywana w Local Storage
            const storageKey = 'naming_convention_V3';
            
            // Sprawdzenie, czy zosta≈Ça wybrana poprawna warto≈õƒá (nie placeholder)
            if (selectedValue) {
                // Zapisanie warto≈õci do Local Storage
                localStorage.setItem(storageKey, selectedValue);
                
                // Opcjonalny komunikat w konsoli
                console.log(`Saved to Local Storage: ${storageKey} = ${selectedValue}`);
            }
        }        

        const Int_paramListDiv = document.getElementById('Int_paramListDiv');
        const Chrom_paramListDiv = document.getElementById('Chrom_paramListDiv');
        const Qname_paramListDiv = document.getElementById('Qname_paramListDiv');
        const Pha_paramListDiv = document.getElementById('Pha_paramListDiv');        

        // wczytaj wcze≈õniej zapisane zaznaczenia jako obiekt
        let wybrane = {};
        try {
        wybrane = JSON.parse(localStorage.getItem('wybraneParametryTLCv3')) || {};
        if (typeof wybrane !== "object" || wybrane === null || Array.isArray(wybrane)) {
            wybrane = {};
        }
        } catch (e) { wybrane = {}; }

        // generowanie listy checkbox√≥w
        paramDescriptions.forEach(desc => {
        const id = 'param_' + desc.name.replace(/\s+/g, '_'); // unikalne ID
        const wrapper = document.createElement('div');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = id;
        checkbox.value = desc.name; // tu ustawiana nazwa chceboxa - nie zmieniaƒá
        checkbox.checked = !!wybrane[desc.name]; // true je≈õli wcze≈õniej zaznaczone

        const label = document.createElement('label');
        label.htmlFor = id;

        // changing name to alterntive - START
        const storedValue = localStorage.getItem('naming_convention_V3'); // wczytujemy naming convention
        const selectElement_NC = document.getElementById('namingConventionSelect');
        selectElement_NC.value = storedValue; // ustawia odpowiedniƒÖ value na selected

        if (!storedValue || storedValue === "debug") {
            label.textContent = desc.name; // tu ustawiona nazwa label
        } else {
            // Spr√≥buj znale≈∫ƒá skr√≥t w nawiasie, np. "PN" z "Peak Name (PN)"
            const match = desc.name.match(/\(([^)]*)\)/);

            // Zmienna na skr√≥t (np. "PN")
            const matchSingle = match ? match[1] : null; 

            // Sprawdzenie: Czy znaleziono skr√≥t ORAZ czy skr√≥t istnieje jako klucz w namingConvention
            const isValidKey = matchSingle && namingConvention.hasOwnProperty(matchSingle);

            if (isValidKey) {
                // Je≈õli klucz jest poprawny, przejd≈∫ do logiki z namingConvention
                const changedElement = namingConvention[matchSingle];

                if (storedValue === "descriptive") {
                    label.innerHTML = changedElement.desc; // wstawia opis
                } else if (storedValue === "abbreviated") {
                    label.innerHTML = changedElement.abbv; // wstawia skr√≥t (HTML)
                } else if (storedValue === "desc_abbrev") {
                    // U≈ºyj changedElement, kt√≥re jest ju≈º zdefiniowane
                    label.innerHTML = `${changedElement.desc} (${changedElement.abbv})`;
                } else {
                    // W przypadku nieznanego storedValue, ustaw domy≈õlnie
                    label.textContent = desc.name;
                }

            } else {
                // Zabezpieczenie: Je≈õli matchSingle nieznalezione lub klucz nie istnieje
                label.textContent = desc.name;
            }
        }     
        // changing name to alterntive - END

        wrapper.appendChild(checkbox);
        wrapper.appendChild(label);
        if (desc.type === "int"){ // bisque
            Int_paramListDiv.appendChild(wrapper);
        }
        else if(desc.type === "chrom"){ // Thistle
            Chrom_paramListDiv.appendChild(wrapper);
        }
        else if(desc.type === "qname"){ // white
            Qname_paramListDiv.appendChild(wrapper);
        }
        else if(desc.type === "pha"){ // lavender
            Pha_paramListDiv.appendChild(wrapper);
        }                

        // event po zmianie checkboxa
        checkbox.addEventListener('change', () => {
            // odczyt wszystkich checkbox√≥w
            wybrane = {};
            Array.from(Int_paramListDiv.querySelectorAll('input[type=checkbox]:checked'))
            .forEach(cb => wybrane[cb.value] = true);

            Array.from(Chrom_paramListDiv.querySelectorAll('input[type=checkbox]:checked'))
            .forEach(cb => wybrane[cb.value] = true);     
            
            Array.from(Qname_paramListDiv.querySelectorAll('input[type=checkbox]:checked'))
            .forEach(cb => wybrane[cb.value] = true);

            Array.from(Pha_paramListDiv.querySelectorAll('input[type=checkbox]:checked'))
            .forEach(cb => wybrane[cb.value] = true);             

            // zapis do localStorage jako JSON obiekt
            localStorage.setItem('wybraneParametryTLCv3', JSON.stringify(wybrane));
        });
        });       
        
        // odznacza parametry
        const clearBtn = document.getElementById('clearSelection');

        clearBtn.addEventListener('click', () => {
            // wyczy≈õƒá zmiennƒÖ i localStorage
            wybrane = {};
            localStorage.setItem('wybraneParametryTLCv3', JSON.stringify(wybrane));

            // od≈õwie≈º stronƒô
            window.location.reload();
        });        


    // liczba miejsc po przecinku
    const decimalsInput = document.getElementById("decimalsInput");

    let decimals = -1;
    try {
        const stored = JSON.parse(localStorage.getItem('decimalsTLCv3'));
        if (typeof stored === 'number') {
            decimals = stored;
        } else {
            decimals = -1; // je≈õli w localStorage co≈õ jest, ale nie liczba
        }
    } catch (e) {
        decimals = -1; // je≈õli JSON niepoprawny
    }

    // ustaw warto≈õƒá inputa
    decimalsInput.value = decimals;

    // event przy zmianie inputa
    decimalsInput.addEventListener("change", () => {
        // odczytaj nowƒÖ warto≈õƒá z inputa i zapisz
        const value = Number(decimalsInput.value);
        if (Number.isNaN(value)) {
            decimals = -1; // je≈õli co≈õ nie jest liczbƒÖ
        } else {
            decimals = value;
        }
        localStorage.setItem('decimalsTLCv3', JSON.stringify(decimals));
    });


    // lista potencjalnych substancji do automatycznego wykrycia
    const substancesInput = document.getElementById("substancesInput");

    let substances = [];
    try {
        const stored = JSON.parse(localStorage.getItem('substancesTLCv3'));
        if (Array.isArray(stored)) {
            substances = stored;
        } else {
            substances = []; // je≈õli w localStorage co≈õ jest, ale nie tablica
        }
    } catch (e) {
        substances = []; // je≈õli JSON niepoprawny
    }

    // ustaw warto≈õƒá inputa jako JSON string
    substancesInput.value = JSON.stringify(substances, null, 2);

    // event przy zmianie inputa
    substancesInput.addEventListener("change", () => {
        try {
            // parsuj nowƒÖ warto≈õƒá z inputa
            const value = JSON.parse(substancesInput.value);

            // je≈õli to tablica ‚Äî zapisz, je≈õli nie, wyczy≈õƒá
            if (Array.isArray(value)) {
                substances = value;
            } else {
                substances = [];
            }
        } catch (e) {
            substances = []; // je≈õli wpisano co≈õ niepoprawnego
        }

        // zapisz do localStorage
        localStorage.setItem('substancesTLCv3', JSON.stringify(substances, null, 2));

        // opcjonalnie, od≈õwie≈º input na poprawny JSON
        substancesInput.value = JSON.stringify(substances, null, 2);
    });


    // pr√≥g do wykrycia substancji
    const tresholdInput = document.getElementById("tresholdInput");

    let treshold = 0.05; // warto≈õƒá domy≈õlna
    try {
        const stored = JSON.parse(localStorage.getItem('tresholdTLCv3'));
        if (Number.isFinite(stored) && stored >= 0 && stored <= 1) {
            treshold = stored; // OK, mamy liczbƒô w zakresie
        } else {
            treshold = 0.05; // niepoprawne dane
        }
    } catch (e) {
        treshold = 0.05; // je≈õli JSON niepoprawny
    }

    // ustaw warto≈õƒá inputa
    tresholdInput.value = treshold;

    // event przy zmianie inputa
    tresholdInput.addEventListener("change", () => {
        // parse float z inputa
        const value = parseFloat(tresholdInput.value);
        if (Number.isNaN(value) || value < 0 || value > 1) {
            treshold = 0.05; // je≈õli co≈õ nie jest liczbƒÖ lub poza zakresem
        } else {
            treshold = value;
        }
        localStorage.setItem('tresholdTLCv3', JSON.stringify(treshold));
        tresholdInput.value = treshold; // zaktualizuj input po ewentualnej korekcie
    });
    </script>
</body>
</html>
