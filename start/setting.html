<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Damian Bezara, Karol Wr√≥blewski">
    <meta name="creator" content="Damian Bezara">
    <meta name="keywords" content="TLC, chromatography, analysis, Damian Bezara, Karol Wr√≥blewski, chemical analysis, quantitative analysis, open-source">
    <title>Settings</title>
    <link rel="stylesheet" href="./pushdata.css">
    <link rel="icon" href="/TLC/favicon-32x32.png" sizes="32x32" type="image/png">
    <link rel="icon" href="/TLC/favicon-64x64.png" sizes="64x64" type="image/png">
    <style>
        /* Nowe style dodane dla lepszej estetyki i responsywno≈õci */
        h1 {
            color: #312e81; /* Indigo-800 */
            font-size: 2.5rem; /* 40px */
            font-weight: 800;
        }

        a {
            border-width: 1px;
            border-color: #4f46e5; /* Indigo-600 */
            background-color: #eef2ff; /* Indigo-50 */
            color: #4338ca; /* Indigo-700 */
            font-weight: 600;
            border-radius: 0.5rem;
            padding: 0.75rem;
        }

        a:hover {
            background-color: #e0e7ff; /* Indigo-100 */
        }

        button {
            background-color: #eef2ff; /* Indigo-600 */
            color: #4f46e5;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 700;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            background-color: #4338ca; /* Indigo-700 */
        }
        
        input[type="number"], textarea {
            border: 1px solid #d1d5db; /* Gray-300 */
            padding: 0.5rem;
            border-radius: 0.5rem;
        }
        
        input[type="number"]:focus, textarea:focus {
            outline: none;
            border-color: #4f46e5; /* Indigo-600 */
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }

        /* Ustawienie wyglƒÖdu dla "paramList" */
        #Int_paramListDiv, #Int_paramListDiv {
            display: grid;
            gap: 0.75rem;
            grid-template-columns: repeat(1, minmax(0, 1fr));
            border: solid 2px black;
        }

        #Int_paramListDiv{
            color: #312e81;
        }
    </style>    
</head>

<body>
    <h1>Settings</h1>
    <br>
    <a href="uploader.html" title="photos averaging panel">1Ô∏è‚É£üñºÔ∏è</a>    
    <a href="unwarp.html" title="TLC photos cropping / unwarping panel">2Ô∏è‚É£üìê</a>
    <a href="normaliser.html" title="light equalisation panel">3Ô∏è‚É£üîß</a>    
    <a href="track.html" title="track analysis panel">4Ô∏è‚É£üìä</a>
    <a href="../index.html" title="home">üè†</a>
    <br>
    <hr>
    <br>
    <h3>Select the parameters to include in the report</h3>
    <br>
    <div id="Chrom_paramListDiv"><p>Chromatographic parameters:</p><br></div>
    <br>
    <div id="Int_paramListDiv"><p>Intermediate parameters:</p><br></div>
    <br>
    <hr>
    <br>
    <button id="refresh-cache">refresh cache</button>
    <button id="clearSelection">Deselect all parameters</button>
    <br>
    <hr>
    <br>
    <label for="decimalsInput" title="how many decimal places to include in the report for each parameter">Number of decimal places:</label><input type="number" id="decimalsInput">
    <br>
    <hr>
    <br>
    <!-- Pr√≥g do wykrycia substancji -->
    <label for="tresholdInput" title="How far is it from the nearest model substance to consider it to be this substance? (basing on retardation factor)">
    Substance recognition threshold (0‚Äì1): 
    </label>
    <input type="number" id="tresholdInput" min="0" max="1" step="0.01" value="0.05">
    <br><br>

    <!-- Lista substancji -->
    <label for="substancesInput">List of substances (JSON):</label><br>
    <textarea id="substancesInput" rows="6" cols="60" placeholder='[
    { "x": 0.12, "name": "Substance A" },
    { "x": 0.35, "name": "Substance B" },
    { "x": 0.78, "name": "Substance C" }
    ]'></textarea>

    <script>
        // List of URLs to be cached
        const resourceLinks = [
            '/TLC/start/internalize.js',
            '/TLC/start/datapush.js',
            '/TLC/start/pushdata.css',
            '/TLC/wiki/wiki.css',
            '/TLC/styles.css',            
            // Add more URLs here
        ];

        // Function to cache all resources
        function cacheResources() {
            let promises = resourceLinks.map(url => {
                return fetch(url, { cache: 'force-cache' })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Fail to load resource: ${url}`);
                        }
                        console.log(`Resource loaded: ${url}`);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            });

            // Wait for all resources to be cached
            Promise.all(promises)
                .then(() => {
                    alert('All "v3" resources cached.');
                });
        }

        // Attach the caching function to the button
        document.getElementById('refresh-cache').addEventListener('click', cacheResources);

    //########## - parametry

        // tablica z parametrami
        const paramDescriptions = [
        {name: "Peak Name (PN)", type:"int"},
        {name: "Track Name (TN)", type:"int"},
        {name: "Startpoint to Midpoint Distance at 5% of Height (SM5)", type:"int"},
        {name: "Startpoint to Midpoint Distance at 10% of Height (SM10)", type:"int"},
        {name: "Asymmetry Factor‚Äã‚Äã (AS)", type:"chrom"},
        {name: "Midpoint to Endpoint Distance at 5% of Height (ME5)", type:"int"},
        {name: "Midpoint to Endpoint Distance at 10% of Height (ME10)", type:"int"},
        {name: "Substance Concentration (C)", type:"chrom"},
        {name: "Height Equivalent to a Theoretical Plate - European Pharmacopeia (HETPEP)", type:"chrom"},
        {name: "Height Equivalent to a Theoretical Plate - United States Pharmacopeia (HETPUSP)", type:"chrom"},
        {name: "Capacity Factor (k)", type:"chrom"},
        {name: "Maximal Height on Track (HTrack)", type:"chrom"},
        {name: "Greatest Peak Surface for Track (STrack)", type:"chrom"},
        {name: "Midpoint Index (MI)‚Äã", type:"int"},
        {name: "Number of Theoretical Plates per meter - European Pharmacopeia‚Äã (NEP/m)", type:"chrom"},
        {name: "Number of Theoretical Plates per meter - United States Pharmacopeia (NUSP/m)", type:"chrom"},
        {name: "Number of Theoretical Plates - European Pharmacopeia‚Äã (NEP)", type:"chrom"},
        {name: "Number of Theoretical Plates - United States Pharmacopeia‚Äã (NUSP)", type:"chrom"},
        {name: "Maximal Peak Height (HMax)", type:"chrom"},
        {name: "Peak Height to Track Height Ratio (H%)", type:"chrom"},
        {name: "Peak Surface to Track Surface Ratio (S%)", type:"chrom"},
        {name: "Plate Width in cm (PlW)", type:"int"},
        {name: "Retardation Factor (RF)", type:"chrom"},
        {name: "Logarithmic Retardation Factor (RMLog10)", type:"chrom"},
        {name: "Spot Area¬†(S)", type:"chrom"},
        {name: "Tailing Factor (TF)", type:"chrom"},
        {name: "Track Length in cm (Tl)", type:"int"},
        {name: "Peak Width at 5% Height (PW5)", type:"int"},
        {name: "Peak Width at 10% Height (PW10)", type:"int"},
        {name: "Peak Width at 50% Height (PW50)", type:"int"},
        {name: "Peak Width at 0% Height (PW0)", type:"int"},
        {name: "X Position of Spot Center (XPOS)", type:"int"},
        {name: "Y Position of Spot Center (YPOS)", type:"int"},
        {name: "Separation Factor (Œ±)", type:"chrom"},
        {name: "Efficiency - European Pharmacopeia (EEP)", type:"chrom"},
        {name: "Efficiency - United States Pharmacopeia (EUSP)", type:"chrom"},
        {name: "Normalized Surface (NS)", type:"int"},
        {name: "Retention (Ret)", type:"chrom"},
        {name: "Average Retention Factor (RÀâF)", type:"chrom"},
        {name: "Resolution - European Pharmacopeia (REP)", type:"chrom"},
        {name: "Resolution - United States Pharmacopeia (RUSP)", type:"chrom"},
        {name: "Resolution - Universal Formula (RS)", type:"chrom"},
        {name: "Selectivity (Sel)", type:"chrom"},
        ];


        const Int_paramListDiv = document.getElementById('Int_paramListDiv');
        const Chrom_paramListDiv = document.getElementById('Chrom_paramListDiv');

        // wczytaj wcze≈õniej zapisane zaznaczenia jako obiekt
        let wybrane = {};
        try {
        wybrane = JSON.parse(localStorage.getItem('wybraneParametryTLCv3')) || {};
        if (typeof wybrane !== "object" || wybrane === null || Array.isArray(wybrane)) {
            wybrane = {};
        }
        } catch (e) { wybrane = {}; }

        // generowanie listy checkbox√≥w
        paramDescriptions.forEach(desc => {
        const id = 'param_' + desc.name.replace(/\s+/g, '_'); // unikalne ID
        const wrapper = document.createElement('div');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = id;
        checkbox.value = desc.name;
        checkbox.checked = !!wybrane[desc.name]; // true je≈õli wcze≈õniej zaznaczone

        const label = document.createElement('label');
        label.htmlFor = id;
        label.textContent = desc.name;

        wrapper.appendChild(checkbox);
        wrapper.appendChild(label);
        if (desc.type === "int"){
            Int_paramListDiv.appendChild(wrapper);
        }
        else if(desc.type === "chrom"){
            Chrom_paramListDiv.appendChild(wrapper);
        }

        // event po zmianie checkboxa
        checkbox.addEventListener('change', () => {
            // odczyt wszystkich checkbox√≥w
            wybrane = {};
            Array.from(Int_paramListDiv.querySelectorAll('input[type=checkbox]:checked'))
            .forEach(cb => wybrane[cb.value] = true);

            Array.from(Chrom_paramListDiv.querySelectorAll('input[type=checkbox]:checked'))
            .forEach(cb => wybrane[cb.value] = true);            

            // zapis do localStorage jako JSON obiekt
            localStorage.setItem('wybraneParametryTLCv3', JSON.stringify(wybrane));
        });
        });       
        
        // odznacza parametry
        const clearBtn = document.getElementById('clearSelection');

        clearBtn.addEventListener('click', () => {
            // wyczy≈õƒá zmiennƒÖ i localStorage
            wybrane = {};
            localStorage.setItem('wybraneParametryTLCv3', JSON.stringify(wybrane));

            // od≈õwie≈º stronƒô
            window.location.reload();
        });        


    // liczba miejsc po przecinku
    const decimalsInput = document.getElementById("decimalsInput");

    let decimals = -1;
    try {
        const stored = JSON.parse(localStorage.getItem('decimalsTLCv3'));
        if (typeof stored === 'number') {
            decimals = stored;
        } else {
            decimals = -1; // je≈õli w localStorage co≈õ jest, ale nie liczba
        }
    } catch (e) {
        decimals = -1; // je≈õli JSON niepoprawny
    }

    // ustaw warto≈õƒá inputa
    decimalsInput.value = decimals;

    // event przy zmianie inputa
    decimalsInput.addEventListener("change", () => {
        // odczytaj nowƒÖ warto≈õƒá z inputa i zapisz
        const value = Number(decimalsInput.value);
        if (Number.isNaN(value)) {
            decimals = -1; // je≈õli co≈õ nie jest liczbƒÖ
        } else {
            decimals = value;
        }
        localStorage.setItem('decimalsTLCv3', JSON.stringify(decimals));
    });


    // lista potencjalnych substancji do automatycznego wykrycia
    const substancesInput = document.getElementById("substancesInput");

    let substances = [];
    try {
        const stored = JSON.parse(localStorage.getItem('substancesTLCv3'));
        if (Array.isArray(stored)) {
            substances = stored;
        } else {
            substances = []; // je≈õli w localStorage co≈õ jest, ale nie tablica
        }
    } catch (e) {
        substances = []; // je≈õli JSON niepoprawny
    }

    // ustaw warto≈õƒá inputa jako JSON string
    substancesInput.value = JSON.stringify(substances, null, 2);

    // event przy zmianie inputa
    substancesInput.addEventListener("change", () => {
        try {
            // parsuj nowƒÖ warto≈õƒá z inputa
            const value = JSON.parse(substancesInput.value);

            // je≈õli to tablica ‚Äî zapisz, je≈õli nie, wyczy≈õƒá
            if (Array.isArray(value)) {
                substances = value;
            } else {
                substances = [];
            }
        } catch (e) {
            substances = []; // je≈õli wpisano co≈õ niepoprawnego
        }

        // zapisz do localStorage
        localStorage.setItem('substancesTLCv3', JSON.stringify(substances, null, 2));

        // opcjonalnie, od≈õwie≈º input na poprawny JSON
        substancesInput.value = JSON.stringify(substances, null, 2);
    });


    // pr√≥g do wykrycia substancji
    const tresholdInput = document.getElementById("tresholdInput");

    let treshold = 0.05; // warto≈õƒá domy≈õlna
    try {
        const stored = JSON.parse(localStorage.getItem('tresholdTLCv3'));
        if (Number.isFinite(stored) && stored >= 0 && stored <= 1) {
            treshold = stored; // OK, mamy liczbƒô w zakresie
        } else {
            treshold = 0.05; // niepoprawne dane
        }
    } catch (e) {
        treshold = 0.05; // je≈õli JSON niepoprawny
    }

    // ustaw warto≈õƒá inputa
    tresholdInput.value = treshold;

    // event przy zmianie inputa
    tresholdInput.addEventListener("change", () => {
        // parse float z inputa
        const value = parseFloat(tresholdInput.value);
        if (Number.isNaN(value) || value < 0 || value > 1) {
            treshold = 0.05; // je≈õli co≈õ nie jest liczbƒÖ lub poza zakresem
        } else {
            treshold = value;
        }
        localStorage.setItem('tresholdTLCv3', JSON.stringify(treshold));
        tresholdInput.value = treshold; // zaktualizuj input po ewentualnej korekcie
    });
    </script>
</body>
</html>
